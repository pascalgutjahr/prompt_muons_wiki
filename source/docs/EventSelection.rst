Event Selection
###############

Data
++++
To create an atmospheric muon neutrino sample, the `Aachen Diffuse Upgoing Track event selection <https://iopscience.iop.org/article/10.3847/0004-637X/833/1/3/pdf>`_ is chosen. The arrival direction is restricted to zenith angles between 90° and 120° to exclude tropical latitudes.

The events of the data set are selected by the GoodRunList of the mentioned sample. Further description about the event selection criteria can be found under the following path: /data/ana/Diffuse/AachenUpgoingTracks/exp/Pass2/GRLs_Pass2/README.txt

The data set is constructed as a burn sample (Runs that end with 0) from January 2011 to December 2020. Monthly data sets are generated by the RunID and merged into seasons. Livetimes and number of events are listed below.

.. list-table:: Seasonal Burn Sample
   :widths: 33 33 34
   :header-rows: 1

   * - Season
     - Events
     - Livetime [d]
   * - Jun-Aug
     - 10682
     - 88.4
   * - Dec-Feb
     - 10574
     - 83.4
   * - Mar-Apr
     - 7563
     - 60.8
   * - Sep-Oct
     - 7683
     - 60.2
   * - Jan-Dec
     - 43704
     - 351.0
   * - Jan-Jun
     - 21532
     - 174.3
   * - Jul-Dec
     - 22172
     - 176.7


The distributions of the arrival directions are displayed below:

.. image:: images/azimuth_bns.png
	:width: 49%

.. image:: images/zenith_bns.png
	:width: 49%


Zenith distributions per energy bin. Number of event is set as in 12yr complete data set (523736).

.. image:: images_pass2/zenithdistribution_bin_1-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_2-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_3-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_4-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_5-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_6-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_7-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_8-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_9-1.png
  :width: 49%

.. image:: images_pass2/zenithdistribution_bin_10-1.png
  :width: 49%


MC Simulation
+++++++++++++

Baseline simulation: 21002 (simulated spectrum :math:`E^{-2}`) - analogous to diffuse numu analysis
scattering and absorption parameters: 21003-21006
bulk (hole) ice and DOM efficiency: 21047

Weighting
---------
The MC is weighted to the atmospheric model provided by `MCEq <https://github.com/afedynitch/MCEq>`_.
Primary composition model: Gaisser H3a, hadronic interaction model: SIBYLL2.3c, Atmosphere: MSIS00_IC

The weighting is based on spline fits from the global fit network from Richard Naab and Erik Ganster.
The weights are calculated for the yearly average and for two months: January and July.

Additionally,`astrophysical <https://iopscience.iop.org/article/10.3847/1538-4357/ac4d29>`_ weights are calculated to account for high energy events in the sample with: :math:`1.44e18 \cdot \left(\frac{E}{100TeV}\right)^{-2.37}`
Both, atmospheric and astrophysical weights are added.

Tests on weighting:

.. image:: images_pass2/Pass2_mceqweights_spline_reffolder.pdf-1.png
  :width: 49%

.. image:: images_pass2/Pass2_splineweights_mceq_sampledenergy_finerbinning.pdf-1.png
  :width: 49%


Resampling to an Atmospheric Distribution
-----------------------------------------

The events in the Monte Carlo sample are simulated to follow a power-law :math:`E^{-2}` spectrum. However, atmospheric neutrinos follow a steeper power law with a spectral index of roughly -3.7. The training MC sample has to be resampled to an atmospheric distribution to train the unfolding algorithm on simulated events which are similar to the observed data. Three different methods from `filterpy monte_carlo <https://filterpy.readthedocs.io/en/latest/#filterpy-monte-carlo>`_ filterpy.monte_carlo are tested. The goal is to find the most accurate method and the minimum number of events needed for sampling. The uncertainty of the sampled distribution is estimated by a Poissonian error for weighted histograms. The sampling process works as follows:  `Oneweights <https://docs.icecube.aq/icetray/main/projects/neutrino-generator/weightdict.html?highlight=parameters%20i3mcweightdict#how-to-weight-with-atmospheric-neutrino-flux-using-oneweight>`_ are calculated for every event in the MC sample. The sampling is done with MCEq weights as described in the previous part. Both, the stratified and multinomial resampling methods work well. The multinomial resampling method is chosen for the analysis to construct an atmospheric training sample with 100 000 events. A detailed description of the methods can be found `here <https://filterpy.readthedocs.io/en/latest/monte_carlo/resampling.html>`_.

.. image:: images_pass2/Pass2_comp_sampling_Multinomial_100000.pdf-1.png
	:width: 49%

.. image:: images_pass2/Pass2_comp_sampling_Multinomial_50000.pdf-1.png
	:width: 49%

.. image:: images_pass2/Pass2_comp_sampling_Multinomial_10000.pdf-1.png
	:width: 49%

.. image:: images_pass2/Pass2_comp_sampling_Stratified_100000.pdf-1.png
	:width: 49%

.. image:: images_pass2/Pass2_comp_sampling_Stratified_50000.pdf-1.png
	:width: 49%

.. image:: images_pass2/Pass2_comp_sampling_Stratified_10000.pdf-1.png
	:width: 49%

.. image:: images_pass2/Pass2_comp_sampling_Residual_100000.pdf-1.png
	:width: 49%

Correlation of Unfolding Variables
----------------------------------

.. image:: images_pass2/pass2_corr_besttrack_ltrack_emc.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_besttrack_ndirpulses_emc-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_etrun_emc.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_l5nch_emc.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_l5ndir_emc.pdf-1.png
  :width: 49%

.. image:: images_pass2/pass2_corr_ndirdoms_emc.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_nhitdoms_emc.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_qdirpulses_emc.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_qdirpulses_etrun.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_nhitdoms_etrun.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_l5nch_l5ndir.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_l5nch_etrun.pdf-1.png
	:width: 49%

.. image:: images_pass2/pass2_corr_etrun_l5ndir.pdf-1.png
	:width: 49%



Data-to-MC Agreement
++++++++++++++++++++

The Data-to-MC Agreement is shown for the variables which are selected in the Unfolding section. Atmospheric and astrophysical weights have been added. Data error is
given by Poisson. MC uncertainty is given by: :math:`\sqrt{\sum_i weights_i^2}`

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_BestTrackDirectHitsICC.dir_track_length_10yr_21002.pdf-1.png
	:width: 49%

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_BestTrackDirectHitsICC.n_dir_pulses_10yr_21002-1.png
	:width: 49%

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_BestTrackDirectHitsICC.n_dir_doms_10yr_21002-1.png
	:width: 49%

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_BestTrackDirectHitsICC.q_dir_pulses_10yr_21002.pdf-1.png
	:width: 49%

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_HitMultiplicityValues.n_hit_doms_10yr_21002.pdf-1.png
	:width: 49%

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_SplineMPEICTruncatedEnergySPICEMie_BINS_Neutrino.energy_10yr_21002.pdf-1.png
	:width: 49%

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_L5_nch.value_10yr_21002.pdf-1.png
  :width: 49%

.. image:: images_pass2/datavsmc_bns_atmastro_unnormed_L5_ndir_c.value_10yr_21002.pdf-1.png
	:width: 49%

An offset around 20% is observable which is consistent with the `diffuse numu analysis <https://user-web.icecube.wisc.edu/~jstettner/DiffuseExtensions_wiki/html/index.html>_`. The normalization in that analysis was fitted by a factor of 1.2.
Both are in agreement within atmospheric uncertainties.

The following variables indicate an acceptable agreement: SplineMPEICTruncatedEnergySPICEMie_BINS_Neutrino.energy, L5_nch, L5_ndir_c, BestTrackDirectHitsICC.n_dir_doms,
_HitMultiplicityValues.n_hit_doms
These variables are investigated further in the variable selection.
